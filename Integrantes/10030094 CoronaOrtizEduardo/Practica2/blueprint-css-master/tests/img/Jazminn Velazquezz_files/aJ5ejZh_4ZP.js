/*1357656667,178130529*/

if (self.CavalryLogger) { CavalryLogger.start_js(["wb7wL"]); }

__d("SpotlightPagers",["Event","Arbiter","CSS","DOM","Locale","Parent","Vector","cx","copyProperties","debounce"],function(a,b,c,d,e,f){var g=b('Event'),h=b('Arbiter'),i=b('CSS'),j=b('DOM'),k=b('Locale'),l=b('Parent'),m=b('Vector'),n=b('cx'),o=b('copyProperties'),p=b('debounce');function q(r,s,t,u,v,w,x){this._prev=s;this._next=u;this._target=w;this._spotlight=r;this._viewer=x;this._pageListeners=[];this._subscriptions=[];this._updateTargetPosAndSize();this._prevPagerCallback=t;this._nextPagerCallback=v;i.addClass(this._prev,"_12m");i.addClass(this._next,"_12m");this.disable();this.hidePagers();}o(q,{GO_PREV_AREA:120,FADE_PAGER_TIME:3000,ACTION_PREV:-1,ACTION_NEXT:1});o(q.prototype,{enable:function(){this._pageListeners=[g.listen(this._target,'mousemove',this._onMouseMove.bind(this)),g.listen(this._target,'click',this._clickHandler.bind(this)),g.listen(this._target,'mouseleave',this.hidePagers.bind(this))];this._pageListeners.push(g.listen(window,'resize',this._updateTargetPosAndSize.bind(this)));this._subscriptions=[];if(this._viewer)this._subscriptions.push(h.subscribe(this._viewer.STAGE_RESIZED,this._updateTargetPosAndSize.bind(this)));this._spotlight.subscribe('destroy',this.disable.bind(this));i.show(this._prev);i.show(this._next);this._hidePagerDebouncer=p(this.hidePagers.bind(this),q.FADE_PAGER_TIME);return this;},disable:function(){this._pageListeners.forEach(function(r){r.remove();});this._pageListeners=[];this._subscriptions.forEach(h.unsubscribe);this._subscriptions=[];this._hidePagerDebouncer&&this._hidePagerDebouncer.reset();i.hide(this._prev);i.hide(this._next);return this;},hidePagers:function(event){if(event&&l.byClass(event.getTarget(),"_12m"))return;[this._prev,this._next].forEach(function(r){i.removeClass(r,"_12n");i.addClass(r,"_12o");});},setGoPrevArea:function(r){this._goPrevArea=r;},getGoPrevArea:function(){return this._goPrevArea>=0?this._goPrevArea:q.GO_PREV_AREA;},_updateTargetPosAndSize:function(){this._targetPos=m.getElementPosition(this._target);this._targetSize=m.getElementDimensions(this._target);},_getPageAction:function(event){var r=event.getTarget();if(j.contains(this._prev,r)){return q.ACTION_PREV;}else if(j.contains(this._next,r)){return q.ACTION_NEXT;}else if(!j.contains(this._target,r))return null;var s,t=m.getEventPosition(event),u=Math.min(this._targetSize.x/2,this.getGoPrevArea());if(k.isRTL()){s=this._targetSize.x-(t.x-this._targetPos.x)<u;}else s=t.x-this._targetPos.x<u;return s?q.ACTION_PREV:q.ACTION_NEXT;},_onMouseMove:function(event){i.removeClass(this._prev,"_12o");i.removeClass(this._next,"_12o");var r=this._getPageAction(event);i.conditionClass(this._prev,"_12n",r===q.ACTION_PREV);i.conditionClass(this._next,"_12n",r===q.ACTION_NEXT);this._hidePagerDebouncer(event);},_clickHandler:function(event){var r=this._getPageAction(event);if(r===q.ACTION_PREV){this._prevPagerCallback();}else if(r===q.ACTION_NEXT)this._nextPagerCallback();}});e.exports=q;});
__d("StreamCache",["UIPagelet","copyProperties"],function(a,b,c,d,e,f){var g=b('UIPagelet'),h=b('copyProperties');function i(j,k){this.reset();if(k){this._config=k;this._endpoint=k.endpoint;this._initQuery=k.initQuery;this._bufferSize=k.bufferSize||this._bufferSize;}this._defaultType=j[0];}h(i,{DIR_BACKWARD:-1,DIR_FORWARD:1,DEFAULT_BUFFER_SIZE:2});h(i.prototype,{reset:function(){this._config={};this._isAllLoaded=false;this._keys=[];this._position=0;this._cache={};this._bufferSize=i.DEFAULT_BUFFER_SIZE;this._rightLock=false;this._leftLock=false;},getCursor:function(){return this._keys[this._position];},moveToKey:function(j){var k=this._keys.indexOf(''+j),l=0;if(k!=-1)l=k-this._position;this.moveCursor(l);return this._position;},getCacheContent:function(j,k){k=k||this._defaultType;if(!(j in this._cache)||!(k in this._cache[j]))return null;return this._cache[j][k];},getCurrentCacheContent:function(j){return this.getCacheContent(this.getCursor(),j);},addKeys:function(j,k){j=j.map(function(l){return ''+l;});if(k==i.DIR_BACKWARD){Array.prototype.unshift.apply(this._keys,j);this._position+=j.length;this._leftLock=false;}else if(k==i.DIR_FORWARD){Array.prototype.push.apply(this._keys,j);this._rightLock=false;}this._loaded=true;},storeToCache:function(j){for(var k in j)this._cache[k]=h(this._cache[k]||{},j[k]);},storeToCacheWithKeys:function(j,k){this.storeToCache(j);this.addKeys(Object.keys(j),k);},canPage:function(j){var k=this._keys.length;if(!this._loaded||k===0||k===1)return false;if(this._position<0&&j<0||this._position>=k&&j>0)return false;return true;},moveCursor:function(j){var k=this._keys.length;if(!k||!j)return null;if(this.allLoaded()){this._position=(j%k+this._position+k)%k;}else this._position=j>0?Math.min(this._position+j,k):Math.max(this._position+j,-1);this.fetchMoreIfNecessary(j>0);return this._position;},goNext:function(){return this.moveCursor(1);},goPrev:function(){return this.moveCursor(-1);},fetchMoreIfNecessary:function(j){if(this.allLoaded()||!this._endpoint)return;var k=this._keys.length-1;if(j&&!this._rightLock&&k-this._position<=this._bufferSize){this.fetch(j,this.getFetchQueryData(j,k));}else if(!j&&!this._leftLock&&this._position<=this._bufferSize)this.fetch(j,this.getFetchQueryData(j));},getFetchQueryData:function(j,k){var l=h(this._initQuery,{dir:j?1:-1,cursor:j?this._keys[0]:this._keys[k]});return l;},fetch:function(j,k){if(!this._endpoint)return;g.loadFromEndpoint(this._endpoint,null,k,{usePipe:this._config.useAjaxPipe,jsNonblock:true,crossPage:true});if(j){this._rightLock=true;}else this._leftLock=true;},setAllLoaded:function(){this._isAllLoaded=true;if(!this._total)this.setTotal(this._keys.length);},setTotal:function(j){this._total=j;},allLoaded:function(){return this._isAllLoaded||this._total===this._keys.length;}});e.exports=i;});
__d("MercuryPhotoAttachmentViewer",["Event","CSS","DOM","KeyEventController","SpotlightPagers","StreamCache","Style","Vector","copyProperties","csx","cx"],function(a,b,c,d,e,f){var g=b('Event'),h=b('CSS'),i=b('DOM'),j=b('KeyEventController'),k=b('SpotlightPagers'),l=b('StreamCache'),m=b('Style'),n=b('Vector'),o=b('copyProperties'),p=b('csx'),q=b('cx');function r(){var v=n.getViewportDimensions();return new n(Math.max(u.STAGE_MIN,v.x-u.STAGE_PADDING.x),Math.max(u.STAGE_MIN,v.y-u.STAGE_PADDING.y));}function s(v){var w=r();if(v.x>w.x||v.y>w.y){var x=v.x/v.y,y=w.x/w.y,z,aa;if(x>y){z=w.x;aa=Math.floor(v.y*w.x/v.x);}else{aa=w.y;z=Math.floor(v.x*w.y/v.y);}return new n(z,aa);}return v;}function t(v,w){var x=new n(Math.max(u.STAGE_MIN,v.x,w.x),Math.max(u.STAGE_MIN,v.y)),y=r();return new n(Math.min(x.x,y.x),Math.min(x.y,y.y));}function u(v){this._viewer=v;this._stream=new l(['image']);this._content=i.find(this._viewer.getRoot(),"._12p");this._image=i.find(this._content,"._12-");this._stageDims=new n(0,0);this._listeners=[g.listen(window,'resize',this._adjustImageSize.bind(this))];this._viewer.subscribe('destroy',this._cleanup.bind(this));}o(u,{STAGE_PADDING:{x:75,y:75},STAGE_MIN:400,initViewer:function(v,w,x){var y=new u(v);y.storeData(w,x);}});o(u.prototype,{_image:null,_stream:null,_viewer:null,_loaded:false,storeData:function(v,w){if(this._loaded)return;this._loaded=true;this._stream.storeToCacheWithKeys(v,1);this._stream.setAllLoaded();this._stream.moveToKey(w);if(this._stream.canPage())this._setupPagers();this._switchImage(this._image.src);},_setupPagers:function(event){var v=i.find(this._viewer.getRoot(),"._12r"),w=i.find(this._viewer.getRoot(),"._12s");new k(this._viewer,v,this.page.bind(this,-1),w,this.page.bind(this,1),this._content).enable();this._listeners=this._listeners.concat([j.registerKey('LEFT',function(){this.page(-1);return false;}.bind(this)),j.registerKey('RIGHT',function(){this.page(1);return false;}.bind(this))]);},page:function(v){if(!this._stream.canPage(v))return;this._stream.moveCursor(v);this._switchImage(this._stream.getCurrentCacheContent());},_switchImage:function(v){h.addClass(this._content,"_241");var w=i.create('img',{className:"_12-"});this._imageLoadListener&&this._imageLoadListener.remove();this._imageDims=null;this._imageLoadListener=g.listen(w,'load',function(){this._useNewImage(w);this._imageLoadListener.remove();this._imageLoadListener=null;}.bind(this));w.src=v;},_useNewImage:function(v){this._imageDims=new n(v.width,v.height);i.replace(this._image,v);this._image=v;this._adjustImageSize();h.removeClass(this._content,"_241");},_adjustImageSize:function(){if(!this._imageDims)return;var v=s(this._imageDims);m.set(this._image,'width',v.x+'px');m.set(this._image,'height',v.y+'px');this._stageDims=t(v,this._stageDims);m.set(this._content,'width',this._stageDims.x+'px');m.set(this._content,'height',this._stageDims.y+'px');m.set(this._content,'line-height',this._stageDims.y+'px');},_cleanup:function(){this._stream.reset();this._stream=null;this._listeners.forEach(function(v){v.remove();});this._listeners=[];}});e.exports=u;});